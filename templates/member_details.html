{% extends "base.html" %}

{% block title %}{{ member.name }} - Gym Manager{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('dashboard') }}" style="color: var(--text-muted); text-decoration: none;">&larr; Back to
            Dashboard</a>
    </div>

    <!-- Member Profile Card -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    {% if "Database Schema Error" in message %}
    <div class="card"
        style="background: rgba(239, 68, 68, 0.2); border: 1px solid var(--error); margin-bottom: 2rem; text-align: center;">
        <h3 style="color: var(--error);">âš ï¸ Database Issue Detected</h3>
        <p style="color: white; margin-bottom: 1rem;">The system found a database mismatch (likely missing columns).</p>
        <a href="{{ url_for('fix_database_schema') }}" class="btn btn-warning"
            style="font-weight: bold; background: #f59e0b; color: black; border: none; padding: 0.75rem 2rem;">
            ğŸ› ï¸ CLICK HERE TO FIX DATABASE
        </a>
    </div>
    {% endif %}
    {% endfor %}
    {% endwith %}

    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; gap: 2rem; align-items: start; flex-wrap: wrap;">
            <!-- Photo -->
            <div style="flex-shrink: 0;">
                {% if member.photo %}
                <img src="{{ url_for('static', filename='uploads/' + member.photo) }}"
                    style="width: 150px; height: 150px; border-radius: 20px; object-fit: cover; border: 3px solid var(--accent-gold); box-shadow: 0 0 20px var(--accent-gold-glow);"
                    alt="{{ member.name }}">
                {% else %}
                <div
                    style="width: 150px; height: 150px; border-radius: 20px; background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent-gold)); display: flex; align-items: center; justify-content: center; font-size: 4rem; font-weight: 800; color: white; box-shadow: 0 15px 30px rgba(0,0,0,0.4), 0 0 20px var(--primary-glow);">
                    {{ member.name[0] }}
                </div>
                {% endif %}
            </div>

            <!-- Details -->
            <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <h1 style="margin: 0;">{{ member.name }}</h1>
                    <span class="badge" style="background: var(--bg); border: 1px solid var(--border);">{{
                        member.membership_type or 'Gym' }}</span>
                </div>

                <p style="color: var(--text-muted); margin-top: 0.5rem;">ID: {{ member.id }}</p>

                <div style="margin-top: 1.5rem; display: grid; gap: 0.8rem;">
                    <div><strong style="color: var(--accent-gold);">ğŸ“± Phone:</strong> {{ member.phone }}</div>
                    <div><strong style="color: var(--accent-gold);">ğŸ“… Joined:</strong> {{ member.joined_date }}</div>
                    <div
                        style="font-size: 1.3rem; color: var(--success); margin-top: 0.5rem; font-weight: 800; text-shadow: 0 0 15px rgba(16, 185, 129, 0.3);">
                        <strong style="color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase;">ğŸ’° Total
                            Paid:</strong> {{ gym_details.currency or '$' }}{{
                        history|sum(attribute='amount') }}
                    </div>
                </div>

                <div style="margin-top: 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <a href="https://wa.me/{{ member.phone|replace(' ', '')|replace('-', '') }}?text=Hello {{ member.name }}"
                        target="_blank" class="btn btn-sm"
                        style="background: linear-gradient(135deg, #25D366, #128C7E); box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);">
                        ğŸ’¬ WhatsApp
                    </a>
                    <a href="sms:{{ member.phone|replace(' ', '')|replace('-', '') }}?body=Hello {{ member.name }}"
                        class="btn btn-sm"
                        style="background: linear-gradient(135deg, #f39c12, #d68910); box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">
                        ğŸ’¬ SMS
                    </a>
                    {% if member.email %}
                    <a href="mailto:{{ member.email }}" class="btn btn-sm"
                        style="background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                        âœ‰ï¸ Email
                    </a>
                    {% endif %}
                    <a href="{{ url_for('edit_member', member_id=member.id) }}" class="btn btn-secondary btn-sm">âœï¸
                        Edit</a>
                    <a href="{{ url_for('generate_card', member_id=member.id) }}" class="btn btn-secondary btn-sm">ğŸ“„ ID
                        Card</a>
                    <a href="{{ url_for('generate_wallet_pass', member_id=member.id) }}" class="btn btn-sm"
                        style="background: linear-gradient(135deg, #4285f4, #34a853); box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);">
                        ğŸ“± Add to Google Wallet
                    </a>
                    <form method="POST" action="{{ url_for('delete_member', member_id=member.id) }}"
                        style="display: inline;"
                        onsubmit="return confirm('Are you sure you want to delete this member? This cannot be undone.');">
                        <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Actions -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3>ğŸ’° Record Payment</h3>
        <form method="POST" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end; margin-top: 1rem;">
            <div style="flex: 1; min-width: 200px;">
                <label for="month">Billing Month</label>
                <input type="month" id="month" name="month" required value="{{ current_month }}"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="payment_date">Payment Date</label>
                <input type="date" id="payment_date" name="payment_date" value="{{ today }}"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="amount">Amount</label>
                <input type="number" id="amount" name="amount" required placeholder="Enter amount" min="0" step="0.01">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="notes">Notes</label>
                <input type="text" id="notes" name="notes" placeholder="e.g. Cash, Online..."
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
            </div>

            <button type="submit" class="btn btn-success" style="height: 46px;">âœ… Pay Now</button>
        </form>
    </div>

    <!-- Fee History -->
    <div class="card">
        <h3>ğŸ“œ Payment History</h3>
        {% if history %}
        <table style="margin-top: 1rem;">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Amount</th>
                    <th>Date Paid</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for fee in history %}
                <tr>
                    <td>{{ fee.month }}</td>
                    <td>${{ fee.amount }}</td>
                    <td>{{ fee.paid_date }}</td>
                    <td><span style="font-size: 0.9rem; color: var(--text-muted);">{{ fee.notes or '-' }}</span></td>
                    <td>
                        <a href="{{ url_for('generate_receipt', member_id=member.id, month=fee.month) }}"
                            class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                            ğŸ“„ Receive
                        </a>
                        <a href="{{ url_for('edit_fee_record', member_id=member.id, month=fee.month) }}"
                            class="btn btn-secondary"
                            style="padding: 0.25rem 0.4rem; font-size: 0.8rem; margin-left: 0.5rem; background-color: #f39c12; border-color: #f39c12; color: white;">
                            âœï¸
                        </a>
                        <form action="{{ url_for('delete_fee_record', member_id=member.id, month=fee.month) }}"
                            method="POST" style="display:inline;"
                            onsubmit="return confirm('Delete payment for {{ fee.month }}?');">
                            <button type="submit" class="btn btn-danger"
                                style="padding: 0.25rem 0.4rem; font-size: 0.8rem; margin-left: 0.5rem;">
                                ğŸ—‘ï¸
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No payment history found.</p>
        {% endif %}
    </div>

    <!-- Attendance History -->
    <div class="card" style="margin-top: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">ğŸ•’ Attendance History</h2>
        {% if attendance_history %}
        <div style="max-height: 300px; overflow-y: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visit in attendance_history %}
                    <tr>
                        <td>{{ visit }}</td>
                        <td><span class="badge" style="background: var(--success); color: white;">Check-In</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No visits recorded yet.</p>
        {% endif %}
    </div>

    <!-- Body Measurements Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem; color: var(--primary);">ğŸ“Š Body Measurements</h2>

        <!-- Add Measurement Form -->
        <form method="POST" action="{{ url_for('add_measurement', member_id=member.id) }}" style="margin-bottom: 2rem;">
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Weight
                        (kg) *</label>
                    <input type="number" name="weight" step="0.1" placeholder="70.5" required
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Body Fat
                        (%)</label>
                    <input type="number" name="body_fat" step="0.1" placeholder="15.2"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Chest
                        (cm)</label>
                    <input type="number" name="chest" step="0.1" placeholder="95.0"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Waist
                        (cm)</label>
                    <input type="number" name="waist" step="0.1" placeholder="80.0"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text); font-weight: 600;">Arms
                        (cm)</label>
                    <input type="number" name="arms" step="0.1" placeholder="35.0"
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text);">
                </div>
            </div>
            <textarea name="notes" placeholder="Notes (optional)..." rows="2"
                style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); margin-bottom: 1rem; resize: vertical;"></textarea>
            <button type="submit" class="btn btn-primary">ğŸ’¾ Record Measurement</button>
        </form>

        <!-- Weight Progress Chart -->
        {% if measurements %}
        <div style="background: rgba(15, 23, 42, 0.4); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--secondary);">ğŸ“ˆ Weight Progress</h3>
            <div
                style="display: flex; align-items: flex-end; justify-content: space-around; height: 150px; gap: 0.5rem;">
                {% for m in measurements[:10]|reverse %}
                {% set max_weight = measurements|map(attribute='weight')|select|max %}
                {% set height = (m.weight / max_weight * 100) if m.weight and max_weight else 0 %}
                <div style="flex: 1; max-width: 60px; position: relative;">
                    <div
                        style="height: {{ height }}%; background: linear-gradient(180deg, var(--secondary), var(--primary)); border-radius: 8px 8px 0 0; transition: all 0.3s; position: relative;">
                        <div
                            style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: 700; color: var(--primary); font-size: 0.85rem;">
                            {{ m.weight }}
                        </div>
                    </div>
                    <div style="text-align: center; font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
                        {{ m.recorded_at[5:] }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Measurements History -->
        <h3 style="margin-bottom: 1rem; color: var(--text);">ğŸ“‹ Measurement History</h3>
        <div style="max-height: 300px; overflow-y: auto;">
            {% for m in measurements %}
            <div
                style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 12px; border-left: 3px solid var(--secondary); margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 0.5rem;">
                            {% if m.weight %}
                            <div>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">Weight:</span>
                                <span style="color: var(--text); font-weight: 700; margin-left: 0.25rem;">{{ m.weight }}
                                    kg</span>
                            </div>
                            {% endif %}
                            {% if m.body_fat %}
                            <div>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">Body Fat:</span>
                                <span style="color: var(--text); font-weight: 700; margin-left: 0.25rem;">{{ m.body_fat
                                    }}%</span>
                            </div>
                            {% endif %}
                            {% if m.chest %}
                            <div>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">Chest:</span>
                                <span style="color: var(--text); font-weight: 700; margin-left: 0.25rem;">{{ m.chest }}
                                    cm</span>
                            </div>
                            {% endif %}
                            {% if m.waist %}
                            <div>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">Waist:</span>
                                <span style="color: var(--text); font-weight: 700; margin-left: 0.25rem;">{{ m.waist }}
                                    cm</span>
                            </div>
                            {% endif %}
                            {% if m.arms %}
                            <div>
                                <span style="color: var(--text-muted); font-size: 0.75rem;">Arms:</span>
                                <span style="color: var(--text); font-weight: 700; margin-left: 0.25rem;">{{ m.arms }}
                                    cm</span>
                            </div>
                            {% endif %}
                        </div>
                        {% if m.notes %}
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-muted); font-size: 0.9rem;">ğŸ“ {{ m.notes }}
                        </p>
                        {% endif %}
                        <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">ğŸ“… {{ m.recorded_at
                            }}</small>
                    </div>
                    <a href="{{ url_for('delete_measurement', member_id=member.id, measurement_id=m.id) }}"
                        onclick="return confirm('Delete this measurement?')"
                        style="color: var(--error); text-decoration: none; font-size: 1.2rem; padding: 0.5rem;">ğŸ—‘ï¸</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: var(--text-muted); padding: 2rem;">No measurements recorded yet. Add one
            above!</p>
        {% endif %}
    </div>

    <!-- Member Notes Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem; color: var(--primary);">ğŸ“ Admin Notes</h2>

        <!-- Add Note Form -->
        <form method="POST" action="{{ url_for('add_member_note', member_id=member.id) }}" style="margin-bottom: 2rem;">
            <textarea name="note" placeholder="Add a note about this member..." rows="3"
                style="width: 100%; padding: 1rem; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text); font-family: inherit; resize: vertical;"
                required></textarea>
            <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">ğŸ’¾ Save Note</button>
        </form>

        <!-- Notes List -->
        {% if notes %}
        {% for note in notes %}
        <div
            style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 12px; border-left: 3px solid var(--primary); margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <p style="margin: 0; color: var(--text); white-space: pre-wrap;">{{ note.note }}</p>
                    <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">ğŸ•’ {{ note.created_at
                        }}</small>
                </div>
                <a href="{{ url_for('delete_member_note', member_id=member.id, note_id=note.id) }}"
                    onclick="return confirm('Delete this note?')"
                    style="color: var(--error); text-decoration: none; font-size: 1.2rem; padding: 0.5rem;">ğŸ—‘ï¸</a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p style="text-align: center; color: var(--text-muted); padding: 2rem;">No notes yet. Add one above!</p>
        {% endif %}
    </div>

    <!-- Activity Timeline -->
    <div class="card">
        <h2 style="margin-bottom: 1.5rem; color: var(--primary);">ğŸ“… Activity Timeline</h2>

        {% if timeline %}
        <div style="position: relative;">
            <!-- Timeline Line -->
            <div
                style="position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, var(--primary), transparent);">
            </div>

            {% for activity in timeline %}
            <div style="position: relative; padding-left: 60px; margin-bottom: 2rem;">
                <!-- Icon -->
                <div
                    style="position: absolute; left: 0; top: 0; width: 40px; height: 40px; background: var(--bg-card); border: 2px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 10;">
                    {{ activity.icon }}
                </div>

                <!-- Content -->
                <div style="background: rgba(139, 92, 246, 0.05); padding: 1rem; border-radius: 12px; border-left: 3px solid 
                        {% if activity.type == 'payment' %}var(--success)
                        {% elif activity.type == 'checkin' %}var(--secondary)
                        {% else %}var(--primary){% endif %};">
                    <h4 style="margin: 0 0 0.5rem 0; color: var(--text);">{{ activity.title }}</h4>
                    <p style="margin: 0 0 0.5rem 0; color: var(--text-muted);">{{ activity.description }}</p>
                    <small style="color: var(--text-muted);">ğŸ•’ {{ activity.timestamp }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: var(--text-muted); padding: 2rem;">No activity recorded yet</p>
        {% endif %}
    </div>

</div>
{% endblock %}